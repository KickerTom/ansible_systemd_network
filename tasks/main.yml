---
- name: Instantiate systemd-networkd network devices
  template:
    src: netdev.j2
    dest: /etc/systemd/network/{{ netdev.key }}.netdev
    owner: systemd-network
    mode: 0640
  loop: "{{ systemd_networkd_netdevs | dict2items }}"
  loop_control:
    loop_var: netdev
  notify:
    - Reload systemd configuration
    - Restart systemd-networkd

- name: Instantiate systemd-networkd networks
  template:
    src: network.j2
    dest: /etc/systemd/network/{{ network.key }}.network
    owner: systemd-network
  loop: "{{ systemd_networkd_networks | dict2items }}"
  loop_control:
    loop_var: network
  notify:
    - Reload systemd configuration
    - Restart systemd-networkd

- name: Create extra directories relevant for systemd-networkd
  file:
    path: "{{ item | dirname }}"
    state: directory
  loop: "{{ systemd_networkd_copy_files | map(attribute='dest') | list }}"

- name: Copy extra files relevant for systemd-networkd
  copy: "{{ item }}"
  loop: "{{ systemd_networkd_copy_files }}"
  notify:
    - Restart systemd-networkd

- name: Configure resolv.conf
  file:
    dest: /etc/resolv.conf
    state: link
    src: "{{ _systemd_networkd_resolv_conf_paths[systemd_networkd_dns_resolver] }}"
    force: True
  notify:
    - Configure resolver
